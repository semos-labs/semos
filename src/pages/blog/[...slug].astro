---
import Layout from "../../layouts/Layout.astro";
import ViewCount from "../../components/ViewCount.astro";
import { getCollection, render } from "astro:content";

export async function getStaticPaths() {
  const isDev = import.meta.env.DEV;
  const posts = await getCollection("blog", ({ data }) => isDev || !data.draft);
  return posts.map((post) => ({
    params: { slug: post.id },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content } = await render(post);

function formatDate(date: Date) {
  return date.toLocaleDateString("en-US", {
    year: "numeric",
    month: "long",
    day: "numeric",
  });
}
---

<Layout
  title={`${post.data.title} — Semos Blog`}
  description={post.data.description}
  image={`/og/${post.id}.png`}
  type="article"
  publishedTime={post.data.date.toISOString()}
  author="Nick Skriabin"
>
  <!-- JSON-LD Structured Data -->
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "headline": post.data.title,
    "description": post.data.description,
    "image": `https://semos.sh/og/${post.id}.png`,
    "datePublished": post.data.date.toISOString(),
    "author": {
      "@type": "Person",
      "name": "Nick Skriabin",
      "url": "https://semos.sh/about"
    },
    "publisher": {
      "@type": "Organization",
      "name": "Semos Labs",
      "url": "https://semos.sh",
      "logo": {
        "@type": "ImageObject",
        "url": "https://semos.sh/logos/Sema.png"
      }
    },
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": `https://semos.sh/blog/${post.id}`
    },
    ...(post.data.tags ? { "keywords": post.data.tags.join(", ") } : {})
  })} />

  {post.data.draft && (
    <div class="fixed top-0 left-0 right-0 z-50 bg-amber-400/10 border-b border-amber-400/30 backdrop-blur-sm">
      <p class="text-center text-amber-400 text-sm font-mono py-2">
        ⚠ Draft — this post is not published yet
      </p>
    </div>
  )}

  <article class="pt-28 md:pt-36 pb-20 md:pb-28 px-6 md:px-8">
    <div class="max-w-[840px] mx-auto">
      <!-- Back -->
      <a href="/blog" class="inline-flex items-center gap-2 text-small text-gray-500 hover:text-gray-300 transition-colors mb-10">
        ← Back to blog
      </a>

      <!-- Header -->
      <header class="mb-12">
        <div class="flex items-center gap-4 mb-4">
          <time class="text-small text-gray-500 font-mono">
            {formatDate(post.data.date)}
          </time>
          <span class="text-small text-gray-600 font-mono">
            ·
          </span>
          <span class="text-small text-gray-500 font-mono">
            <ViewCount path={`/blog/${post.id}`} />
          </span>
          {post.data.tags && (
            <div class="flex gap-2 flex-wrap">
              {post.data.tags.map((tag: string) => (
                <span class="text-fine text-gray-500 bg-gray-800 px-2 py-0.5 rounded">
                  {tag}
                </span>
              ))}
            </div>
          )}
        </div>
        <h1 class="heading-display mb-4">{post.data.title}</h1>
        <p class="font-prose text-[1.15rem] text-gray-400 leading-copy">{post.data.description}</p>
        {post.data.cover && (
          <div class="relative mt-10">
            <div class="absolute -inset-8 bg-gradient-to-b from-white/[0.03] via-white/[0.06] to-transparent rounded-3xl blur-2xl pointer-events-none"></div>
            <div class="relative bg-gray-900 rounded-xl overflow-hidden shadow-[0_20px_60px_-15px_rgba(0,0,0,0.7)] ring-1 ring-white/[0.08] ring-inset">
              <div class="absolute inset-0 rounded-xl border border-white/[0.06] pointer-events-none z-10"></div>
              <img
                src={post.data.cover}
                alt=""
                class="w-full block"
              />
            </div>
          </div>
        )}
      </header>

      <!-- Content -->
      <div class="prose">
        <Content />
      </div>

      <!-- Footer -->
      <div class="mt-16 pt-8 border-t border-gray-800">
        <a href="/blog" class="text-body-sm text-gray-500 hover:text-gray-300 transition-colors">
          ← All posts
        </a>
      </div>
    </div>
  </article>
</Layout>

<style is:global>
  @reference "../../styles/global.css";
  .prose {
    @apply font-prose text-[1.2rem] text-gray-300 leading-prose;
  }
  .prose h2 {
    @apply font-hand text-[1.6rem] mt-14 mb-5 text-white;
  }
  .prose h3 {
    @apply font-hand text-[1.35rem] mt-10 mb-4 text-white;
  }
  .prose p {
    @apply mb-6;
  }
  .prose a {
    @apply text-white underline underline-offset-4 decoration-gray-600 hover:decoration-gray-400 transition-colors;
  }
  .prose ul, .prose ol {
    @apply mb-6 pl-6;
  }
  .prose li {
    @apply mb-2;
  }
  .prose ul li {
    @apply list-disc;
  }
  .prose ol li {
    @apply list-decimal;
  }
  .prose blockquote {
    @apply pl-5 border-l-2 border-gray-700 text-gray-400 italic my-6;
  }
  .prose code {
    @apply font-mono text-body-sm bg-gray-800 px-1.5 py-0.5 rounded text-gray-200;
  }
  .prose pre {
    @apply bg-gray-900 border border-gray-800 rounded-xl p-5 my-6 overflow-x-auto;
  }
  .prose pre code {
    @apply bg-transparent p-0 rounded-none text-small leading-relaxed;
  }
  .prose img {
    @apply rounded-xl border border-gray-800 my-8;
  }
  .prose hr {
    @apply border-gray-800 my-10;
  }
  .prose strong {
    @apply text-white font-medium;
  }

  /* ── Tables ── */
  .prose table {
    @apply w-full my-8 text-body-sm font-mono border-collapse;
  }
  .prose thead th {
    @apply text-left text-gray-400 font-medium text-fine uppercase tracking-wider
           pb-3 border-b border-gray-700;
  }
  .prose tbody td {
    @apply py-2.5 pr-6 text-gray-300 border-b border-gray-800/60;
  }
  .prose tbody tr:last-child td {
    @apply border-b-0;
  }
  .prose tbody tr:hover td {
    @apply text-white;
  }
  .prose thead th:first-child,
  .prose tbody td:first-child {
    @apply text-gray-400;
  }
</style>
